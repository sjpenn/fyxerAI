<!-- Email Inbox Partial -->
<div class="bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
    <!-- Inbox Header -->
    <div class="border-b border-slate-200 dark:border-slate-700 p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Email Inbox</h2>
            <div class="flex items-center space-x-3">
                <!-- Category Filter -->
                <select class="text-sm border border-slate-200 dark:border-slate-700 rounded-md px-3 py-1 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100"
                        hx-get="/partials/email-inbox/"
                        hx-target="#main-content"
                        hx-trigger="change"
                        hx-include="[name='account']"
                        name="category">
                    <option value="">All Categories</option>
                    <option value="urgent" {% if selected_category == 'urgent' %}selected{% endif %}>Urgent</option>
                    <option value="important" {% if selected_category == 'important' %}selected{% endif %}>Important</option>
                    <option value="newsletter" {% if selected_category == 'newsletter' %}selected{% endif %}>Newsletter</option>
                    <option value="promotion" {% if selected_category == 'promotion' %}selected{% endif %}>Promotion</option>
                    <option value="social" {% if selected_category == 'social' %}selected{% endif %}>Social</option>
                    <option value="notification" {% if selected_category == 'notification' %}selected{% endif %}>Notification</option>
                </select>
                
                <!-- Refresh Button -->
                <button class="btn-sm btn-outline" 
                        hx-get="/partials/email-inbox/"
                        hx-target="#main-content"
                        hx-indicator="#inbox-loading">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="inbox-loading" class="htmx-indicator mt-2">
            <div class="flex items-center text-sm text-slate-500 dark:text-slate-400">
                <div class="animate-spin mr-2 w-4 h-4 border-2 border-slate-300 border-t-blue-600 rounded-full"></div>
                Refreshing inbox...
            </div>
        </div>
    </div>

    <!-- Email List -->
    <div class="divide-y divide-slate-200 dark:divide-slate-700">
        {% if messages %}
            {% for message in messages %}
                <div class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                     hx-get="/api/emails/{{ message.id }}/"
                     hx-target="#email-detail-modal"
                     hx-trigger="click">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <!-- Sender Info -->
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <span class="text-white text-sm font-semibold">
                                            {{ message.sender_name|first|default:message.sender_email|first|upper }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-900 dark:text-slate-100 truncate">
                                        {{ message.sender_name|default:message.sender_email }}
                                    </p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate">
                                        {{ message.sender_email }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Email Content -->
                            <div class="mt-3">
                                <p class="text-sm font-medium text-slate-900 dark:text-slate-100 line-clamp-1">
                                    {{ message.subject }}
                                </p>
                                <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2 mt-1">
                                    {{ message.body_text|truncatewords:20 }}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Message Meta -->
                        <div class="flex flex-col items-end space-y-2 ml-4">
                            <!-- Time -->
                            <span class="text-xs text-slate-500 dark:text-slate-400">
                                {{ message.received_at|timesince }} ago
                            </span>
                            
                            <!-- Category Badge -->
                            <span class="badge badge-{% if message.category == 'urgent' %}error{% elif message.category == 'important' %}warning{% elif message.category == 'newsletter' %}secondary{% else %}primary{% endif %}">
                                {{ message.get_category_display }}
                            </span>
                            
                            <!-- Status Indicators -->
                            <div class="flex items-center space-x-2">
                                {% if not message.is_read %}
                                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                {% endif %}
                                {% if message.is_starred %}
                                    <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                {% endif %}
                                {% if message.has_attachments %}
                                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                    </svg>
                                {% endif %}
                                {% if message.has_draft_reply %}
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <!-- Empty State -->
            <div class="p-12 text-center">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <h3 class="mt-4 text-sm font-medium text-slate-900 dark:text-slate-100">No messages</h3>
                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                    {% if selected_category %}
                        No messages found in "{{ selected_category }}" category.
                    {% else %}
                        No messages found. Connect an email account to get started.
                    {% endif %}
                </p>
                {% if not selected_category %}
                    <div class="mt-6">
                        <button class="btn-primary">
                            Connect Email Account
                        </button>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Load More -->
    {% if messages|length == 20 %}
        <div class="p-4 border-t border-slate-200 dark:border-slate-700">
            <button class="w-full btn-outline text-sm"
                    hx-get="/partials/email-inbox/?offset=20"
                    hx-target="#main-content"
                    hx-swap="outerHTML">
                Load More Messages
            </button>
        </div>
    {% endif %}
</div>

<!-- Hidden modal for email details -->
<div id="email-detail-modal"></div>